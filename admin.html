<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1a1a1a" />
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <title>Admin — Vintage & Glory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lora:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Lora', serif;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Playfair Display', serif;
        }

        .luxury-bg {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        .luxury-input {
            border: 1px solid #d1d5db;
            padding: 10px;
            font-size: 14px;
            font-family: 'Lora', serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .luxury-input:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 2px rgba(26, 26, 26, 0.1);
        }

        .luxury-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
        }

        .luxury-table thead {
            background-color: #f9fafb;
            border-bottom: 2px solid #1a1a1a;
        }

        .luxury-table th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            letter-spacing: 0.1em;
            font-weight: 600;
            color: #1a1a1a;
        }

        .luxury-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>

<body class="bg-white text-gray-900">
    <nav class="luxury-bg text-white sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="index.html" class="text-3xl font-bold tracking-wider"
                style="font-family: 'Playfair Display', serif;">ADMIN PANEL</a>
            <div class="hidden md:flex items-center gap-4">
                <button id="logoutBtn"
                    class="px-4 py-2 bg-red-600 text-white text-sm tracking-widest hover:bg-red-700 transition rounded">LOGOUT</button>
            </div>
            <div class="md:hidden">
                <button id="mobileMenuBtn" class="p-2 rounded-md bg-white text-gray-900"
                    aria-label="Toggle menu">☰</button>
            </div>
        </div>
        <div id="mobileMenu" class="md:hidden bg-white px-6 pb-4 hidden">
            <button id="logoutBtnMobile" class="w-full text-left py-3 text-red-600">Logout</button>
        </div>
    </nav>

    <!-- Auth screen -->
    <div id="authScreen" class="max-w-md mx-auto mt-16 bg-white p-8 shadow-lg">
        <h1 class="text-4xl font-bold mb-8 text-center tracking-tight" style="font-family: 'Playfair Display', serif;">
            Admin Access</h1>
        <form id="adminAuthForm" class="space-y-4">
            <div>
                <label class="block text-sm tracking-widest font-semibold mb-3">EMAIL</label>
                <input id="adminEmail" type="email" placeholder="admin@vintage.local" class="w-full luxury-input"
                    required />
            </div>
            <div>
                <label class="block text-sm tracking-widest font-semibold mb-3">PASSWORD</label>
                <input id="adminPassword" type="password" placeholder="Password" class="w-full luxury-input" required />
            </div>
            <button type="submit"
                class="w-full px-4 py-3 bg-gray-900 text-white text-sm tracking-widest hover:bg-black transition mt-6">SIGN
                IN</button>
        </form>
        <p id="adminAuthMsg" class="text-sm text-gray-600 mt-2 text-center"></p>
        <hr class="my-4">
        <p class="text-xs text-gray-500 text-center">
            <strong>Demo Credentials:</strong><br>
            Email: mzineddine03@gmail.com<br>
            Password: admin123
        </p>
    </div>

    <!-- Admin panel (hidden until auth) -->
    <div id="adminPanel" class="hidden max-w-7xl mx-auto px-6 py-12">
        <div class="flex items-center justify-between mb-12">
            <h1 class="text-4xl font-bold tracking-tight" style="font-family: 'Playfair Display', serif;">Product
                Management</h1>
            <button id="generateBtn"
                class="px-6 py-3 bg-gray-900 text-white text-sm tracking-widest hover:bg-black transition">GENERATE
                SAMPLES</button>
        </div>

        <!-- Add/Edit product form -->
        <div class="bg-white p-8 shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-6 tracking-tight" style="font-family: 'Playfair Display', serif;">
                <span id="formTitle">Add Product</span>
            </h2>
            <form id="productForm" class="space-y-4">
                <div id="productFormMsg" class="hidden p-3 rounded text-sm"></div>
                <div class="text-right">
                    <button type="button" id="checkBucketBtn" class="px-3 py-1 text-xs bg-gray-100 rounded">Check
                        storage bucket</button>
                </div>
                <div>
                    <label class="block text-sm tracking-widest font-semibold mb-3">PRODUCT NAME</label>
                    <input id="productName" type="text" placeholder="e.g. Classic Denim Jacket"
                        class="w-full luxury-input" required />
                </div>
                <div>
                    <label class="block text-sm tracking-widest font-semibold mb-3">DESCRIPTION</label>
                    <textarea id="productDesc" placeholder="Brief description" class="w-full luxury-input"
                        rows="3"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm tracking-widest font-semibold mb-3">PRICE (DZ)</label>
                        <input id="productPrice" type="number" step="0.01" placeholder="49.99"
                            class="w-full luxury-input" required />
                    </div>
                    <div>
                        <label class="block text-sm tracking-widest font-semibold mb-3">IMAGE</label>
                        <div class="space-y-2">
                            <input id="productFile" type="file" accept="image/*" class="w-full" />
                            <input id="productImage" type="url" placeholder="Or paste an image URL (https://...)"
                                class="w-full luxury-input" />
                            <div class="flex items-center gap-2">
                                <input id="removeImage" type="checkbox" class="h-4 w-4" />
                                <label for="removeImage" class="text-sm tracking-widest">Remove current image
                                    URL</label>
                            </div>
                            <div id="productPreviewWrap" class="mt-2">
                                <img id="productPreview" src="" alt="preview"
                                    class="w-32 h-32 object-cover rounded hidden">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" id="submitBtn"
                        class="px-6 py-3 bg-gray-900 text-white text-sm tracking-widest hover:bg-black transition">ADD</button>
                    <button type="button" id="resetBtn"
                        class="px-6 py-3 bg-gray-300 text-gray-900 text-sm tracking-widest hover:bg-gray-400 transition"
                        style="display:none;">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Products table -->
        <div class="bg-white p-8 shadow-lg">
            <h2 class="text-2xl font-semibold mb-6 tracking-tight" style="font-family: 'Playfair Display', serif;">
                Products</h2>
            <div id="productsTable" class="overflow-x-auto">
                <!-- table rendered here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="supabase.js"></script>
    <script src="app.js"></script>
    <script>
        let adminUser = null;
        let editingId = null;

        // Demo credentials
        const DEMO_ADMIN = {
            email: 'mzineddine03@gmail.com',
            password: 'admin123'
        };

        // Helper function for price formatting (in case app.js isn't loaded)
        function formatPrice(p) {
            if (typeof window.formatPrice === 'function') {
                return window.formatPrice(p);
            }
            // Fallback if app.js not loaded
            return Number(p).toFixed(2);
        }

        async function checkAdminAuth() {
            const stored = localStorage.getItem('admin:vintage');
            if (stored) {
                try {
                    adminUser = JSON.parse(stored);
                    showAdminPanel();
                    loadProducts();
                } catch (e) {
                    localStorage.removeItem('admin:vintage');
                }
            }
        }

        async function adminLogin(email, password) {
            const msg = document.getElementById('adminAuthMsg');
            if (!msg) return;

            // Demo authentication
            if (email === DEMO_ADMIN.email && password === DEMO_ADMIN.password) {
                adminUser = { email, loginTime: new Date().toISOString() };
                localStorage.setItem('admin:vintage', JSON.stringify(adminUser));
                msg.textContent = 'Login successful!';
                msg.style.color = '#16a34a';
                
                setTimeout(() => {
                    msg.textContent = '';
                    showAdminPanel();
                    loadProducts();
                    document.getElementById('adminAuthForm').reset();
                }, 1000);
                return;
            }

            msg.textContent = 'Invalid email or password';
            msg.style.color = '#dc2626';
        }

        function showAdminPanel() {
            const authScreen = document.getElementById('authScreen');
            const adminPanel = document.getElementById('adminPanel');
            if (authScreen) authScreen.classList.add('hidden');
            if (adminPanel) adminPanel.classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('admin:vintage');
            adminUser = null;
            editingId = null;
            const adminPanel = document.getElementById('adminPanel');
            const authScreen = document.getElementById('authScreen');
            const authMsg = document.getElementById('adminAuthMsg');
            
            if (adminPanel) adminPanel.classList.add('hidden');
            if (authScreen) authScreen.classList.remove('hidden');
            if (authMsg) authMsg.textContent = '';
        }

        async function loadProducts() {
            try {
                // Check if fetchProducts exists from app.js
                let products = [];
                if (typeof window.fetchProducts === 'function') {
                    products = await window.fetchProducts();
                } else {
                    // Fallback direct fetch
                    const { data, error } = await supabase.from('products').select('*').order('id', { ascending: true });
                    if (error) throw error;
                    products = data || [];
                }
                renderProductsTable(products);
            } catch (error) {
                console.error('Error loading products:', error);
                const table = document.getElementById('productsTable');
                if (table) {
                    table.innerHTML = '<p class="text-red-600">Error loading products. Check console.</p>';
                }
            }
        }

        function renderProductsTable(products) {
            const table = document.getElementById('productsTable');
            if (!table) return;
            
            if (!products || products.length === 0) {
                table.innerHTML = '<p class="text-gray-600">No products yet. Add your first product above.</p>';
                return;
            }
            
            let html = `
                <table class="luxury-table">
                    <thead>
                        <tr>
                            <th>NAME</th>
                            <th>PRICE</th>
                            <th>IMAGE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            products.forEach(p => {
                html += `
                    <tr>
                        <td><strong>${p.name || 'Unnamed'}</strong><br>
                            <small class="text-gray-500 text-sm">${p.description ? p.description.substring(0, 50) + '...' : 'No description'}</small>
                        </td>
                        <td>${formatPrice(p.price || 0)} DZ</td>
                        <td>
                            ${p.image_url ? `<img src="${p.image_url}" alt="${p.name}" class="w-16 h-16 object-cover rounded">` : 'No image'}
                        </td>
                        <td class="flex gap-2">
                            <button class="px-3 py-1 bg-gray-800 text-white rounded text-xs tracking-widest hover:bg-black transition" data-edit="${p.id}">EDIT</button>
                            <button class="px-3 py-1 bg-red-600 text-white rounded text-xs tracking-widest hover:bg-red-700 transition" data-delete="${p.id}">DELETE</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            table.innerHTML = html;
            
            // Add event listeners to the buttons
            table.querySelectorAll('[data-edit]').forEach(btn => {
                btn.addEventListener('click', () => editProduct(btn.getAttribute('data-edit')));
            });
            
            table.querySelectorAll('[data-delete]').forEach(btn => {
                btn.addEventListener('click', () => deleteProduct(btn.getAttribute('data-delete')));
            });
        }

        async function editProduct(id) {
            try {
                let product;
                if (typeof window.fetchProductById === 'function') {
                    product = await window.fetchProductById(id);
                } else {
                    // Fallback direct fetch
                    const { data, error } = await supabase.from('products').select('*').eq('id', id).single();
                    if (error) throw error;
                    product = data;
                }
                
                if (!product) {
                    alert('Product not found');
                    return;
                }
                
                editingId = id;
                document.getElementById('formTitle').textContent = 'Edit Product';
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productDesc').value = product.description || '';
                document.getElementById('productPrice').value = product.price || 0;
                document.getElementById('productImage').value = product.image_url || '';
                
                // Preview existing image
                const preview = document.getElementById('productPreview');
                if (preview && product.image_url) {
                    preview.src = product.image_url;
                    preview.classList.remove('hidden');
                }
                
                document.getElementById('submitBtn').textContent = 'Update';
                document.getElementById('resetBtn').style.display = 'inline-block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Error loading product: ' + error.message);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) return;
            
            try {
                if (typeof window.adminDeleteProduct === 'function') {
                    await window.adminDeleteProduct(id);
                } else {
                    // Fallback direct delete
                    const { error } = await supabase.from('products').delete().eq('id', id);
                    if (error) throw error;
                    alert('Product deleted successfully');
                }
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product: ' + error.message);
            }
        }

        function resetForm() {
            editingId = null;
            const form = document.getElementById('productForm');
            if (form) form.reset();
            
            document.getElementById('formTitle').textContent = 'Add Product';
            document.getElementById('submitBtn').textContent = 'Add';
            document.getElementById('resetBtn').style.display = 'none';
            
            // Clear preview and file input
            const preview = document.getElementById('productPreview');
            if (preview) {
                preview.src = '';
                preview.classList.add('hidden');
            }
            
            const fileInput = document.getElementById('productFile');
            if (fileInput) fileInput.value = '';
            
            const removeCb = document.getElementById('removeImage');
            if (removeCb) removeCb.checked = false;
            
            const msgEl = document.getElementById('productFormMsg');
            if (msgEl) {
                msgEl.className = 'hidden p-3 rounded text-sm';
                msgEl.textContent = '';
            }
        }

        // Simplified image upload function
        async function uploadProductImage(file) {
            try {
                const filePath = `product-images/${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                const { data, error } = await supabase.storage
                    .from('product-images')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false,
                        contentType: file.type
                    });
                
                if (error) throw error;
                
                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('product-images')
                    .getPublicUrl(filePath);
                
                return urlData.publicUrl;
            } catch (error) {
                console.error('Image upload error:', error);
                throw error;
            }
        }

        // Main form submission handler
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('productName').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const imageUrlInput = document.getElementById('productImage').value.trim();
            const fileInput = document.getElementById('productFile');
            const removeChecked = document.getElementById('removeImage').checked;
            
            // Validation
            if (!name) {
                alert('Product name is required');
                return;
            }
            
            if (!price || price <= 0) {
                alert('Valid price is required');
                return;
            }
            
            const msgEl = document.getElementById('productFormMsg');
            if (msgEl) {
                msgEl.className = 'hidden p-3 rounded text-sm';
                msgEl.textContent = '';
            }
            
            let finalImageUrl = '';
            
            // Handle image
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                try {
                    const file = fileInput.files[0];
                    msgEl.textContent = 'Uploading image...';
                    msgEl.className = 'p-3 rounded bg-blue-50 text-blue-800';
                    msgEl.classList.remove('hidden');
                    
                    finalImageUrl = await uploadProductImage(file);
                    
                    msgEl.textContent = 'Image uploaded successfully!';
                    msgEl.className = 'p-3 rounded bg-green-50 text-green-800';
                } catch (error) {
                    msgEl.textContent = 'Image upload failed. Using provided URL or no image.';
                    msgEl.className = 'p-3 rounded bg-yellow-50 text-yellow-800';
                    
                    if (imageUrlInput) {
                        finalImageUrl = imageUrlInput;
                    }
                }
            } else if (removeChecked) {
                finalImageUrl = '';
            } else if (imageUrlInput) {
                finalImageUrl = imageUrlInput;
            }
            
            // Create payload
            const payload = {
                name,
                description: desc,
                price,
                image_url: finalImageUrl || null
            };
            
            try {
                if (editingId) {
                    // Update existing product
                    if (typeof window.adminUpdateProduct === 'function') {
                        await window.adminUpdateProduct(editingId, payload);
                    } else {
                        const { error } = await supabase
                            .from('products')
                            .update(payload)
                            .eq('id', editingId);
                        if (error) throw error;
                    }
                    alert('Product updated successfully!');
                } else {
                    // Create new product
                    if (typeof window.adminCreateProduct === 'function') {
                        await window.adminCreateProduct(payload);
                    } else {
                        const { error } = await supabase
                            .from('products')
                            .insert([payload]);
                        if (error) throw error;
                    }
                    alert('Product created successfully!');
                }
                
                resetForm();
                loadProducts();
                
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product: ' + error.message);
            }
        });

        // Event listeners setup
        document.addEventListener('DOMContentLoaded', () => {
            // Admin auth form
            const authForm = document.getElementById('adminAuthForm');
            if (authForm) {
                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('adminEmail').value;
                    const password = document.getElementById('adminPassword').value;
                    await adminLogin(email, password);
                });
            }
            
            // Logout buttons
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to logout?')) {
                        logout();
                    }
                });
            }
            
            const logoutBtnMobile = document.getElementById('logoutBtnMobile');
            if (logoutBtnMobile) {
                logoutBtnMobile.addEventListener('click', () => {
                    if (confirm('Are you sure you want to logout?')) {
                        logout();
                    }
                });
            }
            
            // Reset form button
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetForm);
            }
            
            // Generate samples button
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', async () => {
                    if (confirm('This will create 6 sample products. Continue?')) {
                        try {
                            if (typeof window.generateSampleProducts === 'function') {
                                await window.generateSampleProducts();
                            } else {
                                alert('Sample generation function not available');
                            }
                            loadProducts();
                        } catch (error) {
                            console.error('Error generating samples:', error);
                            alert('Error generating samples: ' + error.message);
                        }
                    }
                });
            }
            
            // Check bucket button
            const checkBucketBtn = document.getElementById('checkBucketBtn');
            if (checkBucketBtn) {
                checkBucketBtn.addEventListener('click', async () => {
                    const msgEl = document.getElementById('productFormMsg');
                    try {
                        const { data, error } = await supabase.storage
                            .from('product-images')
                            .list('', { limit: 50 });
                        
                        if (error) {
                            msgEl.textContent = 'Error: ' + error.message;
                            msgEl.className = 'p-3 rounded bg-red-100 text-red-700';
                            msgEl.classList.remove('hidden');
                        } else {
                            msgEl.textContent = `Found ${data.length} items in storage bucket`;
                            msgEl.className = 'p-3 rounded bg-green-50 text-green-800';
                            msgEl.classList.remove('hidden');
                            console.log('Bucket contents:', data);
                        }
                    } catch (err) {
                        msgEl.textContent = 'Exception: ' + err.message;
                        msgEl.className = 'p-3 rounded bg-red-100 text-red-700';
                        msgEl.classList.remove('hidden');
                    }
                });
            }
            
            // Image preview for file input
            const productFileEl = document.getElementById('productFile');
            const productPreviewEl = document.getElementById('productPreview');
            if (productFileEl && productPreviewEl) {
                productFileEl.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        productPreviewEl.src = URL.createObjectURL(file);
                        productPreviewEl.classList.remove('hidden');
                    }
                });
            }
            
            // Image preview for URL input
            const productImageInput = document.getElementById('productImage');
            if (productImageInput && productPreviewEl) {
                productImageInput.addEventListener('input', (e) => {
                    const url = e.target.value.trim();
                    if (url) {
                        productPreviewEl.src = url;
                        productPreviewEl.classList.remove('hidden');
                    }
                });
            }
            
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
            
            // Initial check for existing auth
            checkAdminAuth();
        });
    </script>
</body>

</html>
