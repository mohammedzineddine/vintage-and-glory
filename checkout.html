<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1a1a1a" />
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <title>Checkout — Vintage & Glory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="youcan-wilaya-plugin.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lora:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Lora', serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        .luxury-bg {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        .luxury-input {
            border: 1px solid #d1d5db;
            padding: 10px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .luxury-input:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 2px rgba(26, 26, 26, 0.08);
        }

        .delivery-option {
            border: 2px solid #d1d5db;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .delivery-option:hover {
            border-color: #9ca3af;
        }

        .delivery-option.selected {
            border-color: #1a1a1a;
            background-color: #f9fafb;
        }
    </style>
</head>

<body class="bg-white text-gray-900">
    <nav class="luxury-bg text-white sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="index.html" class="text-3xl font-bold tracking-wider"
                style="font-family: 'Playfair Display', serif;">VINTAGE & GLORY</a>
            <div class="hidden md:flex items-center gap-8">
                <a href="index.html" class="text-sm tracking-widest hover:text-gray-300 transition">SHOP</a>
                <a href="about.html" class="text-sm tracking-widest hover:text-gray-300 transition">ABOUT</a>
                <a href="contact.html" class="text-sm tracking-widest hover:text-gray-300 transition">CONTACT</a>
            </div>
            <div class="md:hidden">
                <button id="mobileMenuBtn" class="p-2 rounded-md bg-white text-gray-900"
                    aria-label="Toggle menu">☰</button>
            </div>
        </div>
        <div id="mobileMenu" class="md:hidden bg-white px-6 pb-4 hidden">
            <a href="index.html" class="block py-3 border-b">Shop</a>
            <a href="about.html" class="block py-3 border-b">About</a>
            <a href="contact.html" class="block py-3">Contact</a>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-6 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <section>
                <h1 class="text-4xl mb-6">Checkout</h1>
                <p class="text-gray-700 mb-6">Please provide delivery details. ZR Express shipping is calculated per
                    wilaya.</p>

                <form id="checkoutForm" class="space-y-6 bg-white p-8 shadow-lg">
                    <div>
                        <label class="block text-sm tracking-widest font-semibold mb-2">RECIPIENT NAME</label>
                        <input id="custName" type="text" class="w-full luxury-input rounded" required />
                    </div>

                    <div>
                        <label class="block text-sm tracking-widest font-semibold mb-2">PHONE</label>
                        <input id="custPhone" type="tel" class="w-full luxury-input rounded" required />
                    </div>

                    <div>
                        <label class="block text-sm tracking-widest font-semibold mb-2">ADDRESS</label>
                        <input id="custAddress" type="text" class="w-full luxury-input rounded" required />
                    </div>

                    <div>
                        <label class="block text-sm tracking-widest font-semibold mb-2">WILAYA (ZR Express)</label>
                        <select id="custWilaya" class="w-full luxury-input rounded" required>
                            <!-- options populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm tracking-widest font-semibold mb-4">DELIVERY TYPE</label>
                        <div class="space-y-3">
                            <div class="delivery-option rounded selected" data-delivery="home">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-5 h-5 border-2 border-gray-900 rounded-full flex items-center justify-center">
                                            <div class="w-3 h-3 bg-gray-900 rounded-full"></div>
                                        </div>
                                        <div>
                                            <div class="font-semibold">Home Delivery (للمنزل)</div>
                                            <div class="text-sm text-gray-600">Deliver to your home address</div>
                                        </div>
                                    </div>
                                    <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                                        </path>
                                    </svg>
                                </div>
                            </div>

                            <div class="delivery-option rounded" data-delivery="office">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-5 h-5 border-2 border-gray-400 rounded-full flex items-center justify-center">
                                            <div class="w-3 h-3 bg-transparent rounded-full"></div>
                                        </div>
                                        <div>
                                            <div class="font-semibold">Office Pickup (للمكتب)</div>
                                            <div class="text-sm text-gray-600">Pick up from ZR Express office - Lower
                                                cost</div>
                                        </div>
                                    </div>
                                    <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                        </path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded text-sm text-blue-800">
                            <strong>Cash on Delivery:</strong> Pay when you receive your order via ZR Express.
                        </div>
                    </div>

                    <div id="checkoutMsg" class="hidden p-4 rounded text-sm"></div>

                    <div class="pt-4">
                        <button id="placeOrderBtn" type="submit"
                            class="w-full px-6 py-3 bg-gray-900 text-white tracking-widest hover:bg-black transition">
                            PLACE ORDER
                        </button>
                    </div>
                </form>
            </section>

            <aside>
                <div class="bg-white p-8 shadow-lg">
                    <h2 class="text-2xl mb-4">Order Summary</h2>
                    <div id="summaryItems" class="space-y-4 text-gray-700 mb-6"></div>
                    <div class="flex justify-between text-gray-700 mb-2"><span>Subtotal</span><span id="summarySub">0.00
                            DZ</span></div>
                    <div class="flex justify-between text-gray-700 mb-2"><span>Shipping</span><span
                            id="summaryShipping">—</span></div>
                    <div class="border-t mt-4 pt-4 flex justify-between text-lg font-semibold"><span>Total</span><span
                            id="summaryTotal">0.00 DZ</span></div>
                </div>
            </aside>
        </div>
    </main>

    <footer class="luxury-bg text-white mt-16">
        <div class="max-w-7xl mx-auto px-6 py-12 text-center text-sm text-gray-300">&copy; 2026 Vintage & Glory</div>
    </footer>

    <script>
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => {
            if (!mobileMenu) return;
            mobileMenu.classList.toggle('hidden');
        });

        document.addEventListener('touchstart', function () { }, { passive: true });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="supabase.js"></script>
    <script src="app.js"></script>
    <script>
        // Ensure app.js is loaded and getCart is available
        if (typeof getCart === 'undefined') {
            console.error('getCart is not defined — app.js may not have loaded correctly');
        }

        // Local copy of wilaya shipping rates (ZR Express prices in DZ - Based on official table)
        const WILAYA_RATES = [
            { name: 'Adrar', home: 1350, office: 1100 },
            { name: 'Chlef', home: 850, office: 600 },
            { name: 'Laghouat', home: 950, office: 700 },
            { name: 'Oum El Bouaghi', home: 800, office: 600 },
            { name: 'Batna', home: 800, office: 600 },
            { name: 'Béjaïa', home: 800, office: 600 },
            { name: 'Biskra', home: 950, office: 700 },
            { name: 'Béchar', home: 1300, office: 900 },
            { name: 'Blida', home: 800, office: 600 },
            { name: 'Bouira', home: 750, office: 600 },
            { name: 'Tamanrasset', home: 1600, office: 1300 },
            { name: 'Tébessa', home: 900, office: 600 },
            { name: 'Tlemcen', home: 900, office: 600 },
            { name: 'Tiaret', home: 850, office: 600 },
            { name: 'Tizi Ouzou', home: 850, office: 600 },
            { name: 'Algiers', home: 650, office: 500 },
            { name: 'Djelfa', home: 950, office: 700 },
            { name: 'Jijel', home: 800, office: 600 },
            { name: 'Sétif', home: 750, office: 600 },
            { name: 'Saïda', home: 850, office: 600 },
            { name: 'Skikda', home: 850, office: 600 },
            { name: 'Sidi Bel Abbès', home: 850, office: 600 },
            { name: 'Annaba', home: 850, office: 600 },
            { name: 'Guelma', home: 850, office: 600 },
            { name: 'Constantine', home: 800, office: 600 },
            { name: 'Médéa', home: 800, office: 600 },
            { name: 'Mostaganem', home: 850, office: 600 },
            { name: 'M\'Sila', home: 850, office: 600 },
            { name: 'Mascara', home: 750, office: 600 },
            { name: 'Ouargla', home: 1000, office: 700 },
            { name: 'Oran', home: 850, office: 600 },
            { name: 'El Bayadh', home: 1000, office: 700 },
            { name: 'Illizi', home: 1400, office: 1100 },
            { name: 'Bordj Bou Arreridj', home: 850, office: 600 },
            { name: 'Boumerdes', home: 850, office: 600 },
            { name: 'El Tarf', home: 850, office: 600 },
            { name: 'Tindouf', home: 800, office: 0 },
            { name: 'Tissemsilt', home: 850, office: 600 },
            { name: 'El Oued', home: 1000, office: 700 },
            { name: 'Khenchela', home: 800, office: 0 },
            { name: 'Souk Ahras', home: 850, office: 600 },
            { name: 'Tipaza', home: 850, office: 600 },
            { name: 'Mila', home: 800, office: 600 },
            { name: 'Aïn Defla', home: 850, office: 600 },
            { name: 'Naâma', home: 1200, office: 700 },
            { name: 'Aïn Témouchent', home: 850, office: 600 },
            { name: 'Ghardaïa', home: 1000, office: 700 },
            { name: 'Relizane', home: 850, office: 600 },
            { name: 'Timimoun', home: 1400, office: 0 },
            { name: 'Bordj Badji Mokhtar', home: 500, office: 400 },
            { name: 'Ouled Djellal', home: 950, office: 700 },
            { name: 'Béni Abbès', home: 1400, office: 1100 },
            { name: 'In Salah', home: 1600, office: 0 },
            { name: 'In Guezzam', home: 1600, office: 700 },
            { name: 'Touggourt', home: 1000, office: 0 },
            { name: 'Djanet', home: 1000, office: 0 },
            { name: 'El M\'Ghair', home: 1000, office: 0 },
            { name: 'El Meniaa', home: 1000, office: 0 }
        ];

        // Track selected delivery type
        let selectedDeliveryType = 'home';

        // Populate wilaya select
        const wilayaSelect = document.getElementById('custWilaya');
        WILAYA_RATES.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w.name;
            opt.dataset.home = w.home;
            opt.dataset.office = w.office;
            opt.textContent = `${w.name} — ${w.home} DZ`;
            wilayaSelect.appendChild(opt);
        });

        // Handle delivery type selection
        document.querySelectorAll('.delivery-option').forEach(option => {
            option.addEventListener('click', function () {
                document.querySelectorAll('.delivery-option').forEach(opt => {
                    opt.classList.remove('selected');
                    const circle = opt.querySelector('.w-5 div');
                    circle.classList.remove('bg-gray-900');
                    circle.classList.add('bg-transparent');
                    const border = opt.querySelector('.w-5');
                    border.classList.remove('border-gray-900');
                    border.classList.add('border-gray-400');
                });

                this.classList.add('selected');
                const circle = this.querySelector('.w-5 div');
                circle.classList.remove('bg-transparent');
                circle.classList.add('bg-gray-900');
                const border = this.querySelector('.w-5');
                border.classList.remove('border-gray-400');
                border.classList.add('border-gray-900');

                selectedDeliveryType = this.dataset.delivery;
                renderSummary();
            });
        });

        function formatPrice(p) {
            return Number(p).toFixed(2);
        }

        function renderSummary() {
            const cart = getCart ? getCart() : [];
            const summaryItems = document.getElementById('summaryItems');
            if (!summaryItems) {
                console.error('summaryItems element not found');
                return;
            }
            summaryItems.innerHTML = '';
            if (cart.length === 0) {
                summaryItems.innerHTML = '<p class="text-center text-gray-500">Your cart is empty. <a href="index.html" class="text-blue-600 underline">Continue shopping</a></p>';
            }
            const subtotal = cart.reduce((s, i) => s + (i.price * (i.qty || 1)), 0);
            cart.forEach(i => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center';
                div.innerHTML = `<div class="text-sm">${i.name} x ${i.qty || 1}</div><div class="text-sm font-medium">${formatPrice(i.price * (i.qty || 1))} DZ</div>`;
                summaryItems.appendChild(div);
            });
            document.getElementById('summarySub').textContent = `${formatPrice(subtotal)} DZ`;

            // set shipping from selected option and delivery type
            const selected = wilayaSelect.selectedOptions[0];
            const priceKey = selectedDeliveryType === 'home' ? 'home' : 'office';
            const ship = selected ? Number(selected.dataset[priceKey]) : 0;

            if (ship === 0 && selectedDeliveryType === 'office' && selected) {
                document.getElementById('summaryShipping').innerHTML = '<span class="text-red-600 text-xs">Office pickup not available</span>';
            } else {
                document.getElementById('summaryShipping').textContent = ship ? `${formatPrice(ship)} DZ` : '—';
            }

            document.getElementById('summaryTotal').textContent = `${formatPrice(subtotal + ship)} DZ`;
        }

        // update summary when wilaya changes
        wilayaSelect.addEventListener('change', renderSummary);

        // initial render
        renderSummary();

        // Wire form submit to app.js function submitCheckout and show inline message
        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const placeBtn = document.getElementById('placeOrderBtn');
            const msgEl = document.getElementById('checkoutMsg');
            msgEl.className = 'hidden p-4 rounded text-sm';

            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const address = document.getElementById('custAddress').value.trim();
            const wilaya = document.getElementById('custWilaya').value;
            const priceKey = selectedDeliveryType === 'home' ? 'home' : 'office';
            const ship = Number(document.getElementById('custWilaya').selectedOptions[0].dataset[priceKey] || 0);

            if (!name || !phone || !address) {
                msgEl.textContent = 'Please complete the form.';
                msgEl.className = 'p-4 rounded bg-red-100 text-red-700';
                msgEl.scrollIntoView({ behavior: 'smooth' });
                return;
            }

            if (ship === 0 && selectedDeliveryType === 'office') {
                msgEl.textContent = 'Office pickup is not available for this wilaya. Please select home delivery.';
                msgEl.className = 'p-4 rounded bg-red-100 text-red-700';
                msgEl.classList.remove('hidden');
                msgEl.scrollIntoView({ behavior: 'smooth' });
                return;
            }

            // Check if submitCheckout is available
            if (typeof submitCheckout === 'undefined') {
                msgEl.textContent = 'Checkout function not available. Please refresh the page.';
                msgEl.className = 'p-4 rounded bg-red-100 text-red-700';
                return;
            }

            placeBtn.disabled = true;
            placeBtn.textContent = 'Placing order...';

            try {
                const result = await submitCheckout({ name, phone, address, wilaya, shipping: ship, deliveryType: selectedDeliveryType });
                if (result && result.success) {
                    msgEl.innerHTML = `Order placed successfully — <strong>Order ID: ${result.orderId}</strong>. Shipping: ${result.shippingCost} DZ.`;
                    msgEl.className = 'p-4 rounded bg-green-50 text-green-800';
                    // show link to continue
                    const cont = document.createElement('div');
                    cont.className = 'mt-4';
                    cont.innerHTML = `<a href="index.html" class="inline-block px-4 py-2 bg-gray-900 text-white rounded">Continue shopping</a>`;
                    msgEl.appendChild(cont);
                    // reset form and update summary display
                    document.getElementById('checkoutForm').reset();
                    selectedDeliveryType = 'home';
                    renderSummary();
                } else {
                    const m = result && result.message ? result.message : 'Checkout failed. Try again.';
                    msgEl.textContent = m;
                    msgEl.className = 'p-4 rounded bg-red-100 text-red-700';
                }
            } finally {
                placeBtn.disabled = false;
                placeBtn.textContent = 'PLACE ORDER';
                msgEl.scrollIntoView({ behavior: 'smooth' });
            }
        });
    </script>
</body>

</html>